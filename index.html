<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Mister Second — Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  body{margin:0;background:#0f1112;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial;height:100vh;display:flex;align-items:center;justify-content:center}
  .card{background:#111;border:1px solid #1e293b;border-radius:12px;padding:20px;width:300px;text-align:center}
  .card img{width:200px;height:200px;object-fit:cover;border-radius:12px;margin-bottom:16px}
  input,button{height:44px;border-radius:10px;border:1px solid #334155;background:#000;color:#fff;padding:0 12px;font-size:15px;box-sizing:border-box;width:100%}
  button{margin-top:10px;cursor:pointer}
  #loginBtn{border-color:#0d6efd}
  #getKeyBtn{border-color:#22c55e}
  .muted{color:#9fb3c0;font-size:13px;margin-top:10px}
  .ok{color:#22c55e}.warn{color:#f59e0b}.err{color:#ef4444}
  .hide{display:none}

  /* Toast */
  #toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #111;
    color: #fff;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, bottom 0.3s ease;
    z-index: 9999;
  }
  #toast.show { opacity:1; bottom:40px; pointer-events:auto; }
  #toast.err { border:1px solid #ef4444; color:#ef4444; }
  #toast.ok { border:1px solid #22c55e; color:#22c55e; }
  #toast.warn { border:1px solid #f59e0b; color:#f59e0b; }
</style>
</head>
<body>

<div id="toast"></div>

<!-- LOGIN VIEW -->
<section id="loginView" class="card">
  <img src="https://i.postimg.cc/XvXvtGL3/odified.png" alt="Logo" />
  <h2 style="margin:0 0 8px">Enter Access Key</h2>
  <input id="keyInput" placeholder="Paste your access key…" autocomplete="one-time-code" />
  <button id="loginBtn">LOGIN</button>
  <button id="getKeyBtn">GET KEY</button>
  <div id="msg" class="muted"></div>
</section>

<!-- MAIN VIEW -->
<section id="mainView" class="card hide">
  <h2 style="margin:0 0 8px">Welcome ✅</h2>
  <div id="accessState" class="muted" style="margin-bottom:12px"></div>
  <div class="pill" id="expiresPill"></div>
  <div style="margin-top:16px;display:flex;gap:8px">
    <button id="logoutBtn" style="border-color:#ef4444">LOGOUT</button>
    <button id="refreshBtn">ACCESS</button>
  </div>
</section>

<script>
const GITHUB_JSON_URL = "https://raw.githubusercontent.com/mesecond900/WEB-ACCESS-/main/key.json";
const GET_LOGIN_URL = "https://wa.me/923235633449";

let cache = { users: [] };
const $ = (id) => document.getElementById(id);

const keyInput = $("keyInput");
const loginBtn = $("loginBtn");
const getKeyBtn = $("getKeyBtn");
const msg = $("msg");
const loginView = $("loginView");
const mainView = $("mainView");
const expiresPill = $("expiresPill");
const accessState = $("accessState");
const logoutBtn = $("logoutBtn");
const refreshBtn = $("refreshBtn");

// Toast
function showToast(message, type="ok") {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.className = "show " + type;
  setTimeout(() => { toast.className = toast.className.replace("show",""); }, 3000);
}

// Bootstrap
const saved = JSON.parse(localStorage.getItem("ms_session") || "null");
if (saved && saved.key) {
  bootstrap().then(() => validateKey(saved.key, true));
} else {
  bootstrap();
}

async function bootstrap() {
  try {
    const res = await fetch(GITHUB_JSON_URL + "?t=" + Date.now(), {cache:"no-store"}); // force no cache
    if (!res.ok) throw new Error("GitHub fetch failed");
    cache = await res.json();
  } catch (e) {
    msg.innerHTML = `<span class="err">Unable to fetch access list.</span>`;
  }
}

function validateKey(key, silent=false) {
  const rec = (cache.users || []).find(u => String(u.key).trim() === String(key).trim());
  if (!rec) {
    if (!silent) showToast("Not registered ❌", "warn");
    showLogin();
    return false;
  }

  const now = new Date();
  const exp = new Date(rec.expires);

  if (exp <= now) {
    localStorage.removeItem("ms_session");
    showToast("Key expired on " + exp.toLocaleString(), "err");
    showLogin();
    return false;
  }

  localStorage.setItem("ms_session", JSON.stringify({ key, ts: now.toISOString() }));
  accessState.innerHTML = `<span class="ok">Access granted</span>`;
  expiresPill.textContent = `Expires: ${exp.toLocaleString()}`;
  showToast("Access granted ✅", "ok");
  showMain();
  return true;
}

function showLogin(){loginView.classList.remove("hide");mainView.classList.add("hide")}
function showMain(){loginView.classList.add("hide");mainView.classList.remove("hide")}

loginBtn.addEventListener("click", () => {
  const key = (keyInput.value || "").trim();
  if (!key) { showToast("Please enter your access key.", "warn"); return; }
  validateKey(key);
});
keyInput.addEventListener("keyup", (e) => { if (e.key === "Enter") loginBtn.click(); });
getKeyBtn.addEventListener("click", () => { window.open(GET_LOGIN_URL, "_blank"); });
logoutBtn.addEventListener("click", () => {
  localStorage.removeItem("ms_session");
  msg.textContent="";
  keyInput.value="";
  showLogin();
  showToast("Logged out ❌", "warn");
  
});

// Refresh Button
refreshBtn.addEventListener("click", async () => {
  await bootstrap();
  const s = JSON.parse(localStorage.getItem("ms_session") || "null");
  if (s && s.key) {
    const valid = validateKey(s.key, true);
    if (valid) {
      showToast("Access refreshed ✅", "ok");
      window.location.href = "home.html"; // apna page ka naam dal
    }
  }
});
</script>
</body>
</html>
